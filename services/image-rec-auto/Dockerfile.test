ARG BASE_BUILDER=alpine:3.9
ARG BASE=uavaustin/hawk-eye-arm:0.0.1a

# Compile the proto files (using alpine for easy recent protoc
# install).
FROM ${BASE_BUILDER} AS builder

WORKDIR /builder

RUN apk --no-cache add \
    protobuf

COPY common/messages/image_rec.proto \
    common/messages/imagery.proto \
    common/messages/interop.proto \
    common/messages/telemetry.proto \
    messages/

RUN mkdir dist && protoc --python_out=dist messages/*.proto

# Testing image.
FROM ${BASE}

WORKDIR /test

# Needed for OpenCV.
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \ 
    python3-pip

COPY common/python/requirements.txt common/requirements.txt
COPY image-rec-auto/requirements.txt .
COPY image-rec-auto/requirements-test.txt .

RUN pip install \
    -r common/requirements.txt \
    -r requirements.txt \
    -r requirements-test.txt

# Copy the protobuf messages from above.
COPY --from=builder /builder/dist/messages messages

COPY common/python common
COPY image-rec-auto/service service
COPY image-rec-auto/test test
COPY image-rec-auto/setup.cfg .

ENV PYTHONUNBUFFERED=TRUE

CMD pycodestyle service test && python -m pytest --cov=service test && \
    coverage html -d coverage/html
